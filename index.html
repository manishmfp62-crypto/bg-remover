 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Background Remover</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; width: 100%; max-width: 500px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; text-align: center; position: relative; }
        .header { background: #4f46e5; color: white; padding: 20px; }
        .header h2 { margin: 0; font-size: 20px; }
        
        /* Upload Area */
        .upload-box { padding: 40px 20px; border: 2px dashed #cbd5e1; margin: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .upload-box:hover { border-color: #4f46e5; background: #eef2ff; }
        
        /* Loader */
        .loader { display: none; padding: 30px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 15px; }
        
        /* Result Area */
        .result-box { display: none; padding: 20px; }
        .img-wrapper { width: 100%; height: 300px; background-image: linear-gradient(45deg,#ccc 25%,transparent 25%), linear-gradient(-45deg,#ccc 25%,transparent 25%), linear-gradient(45deg,transparent 75%,#ccc 75%), linear-gradient(-45deg,transparent 75%,#ccc 75%); background-size: 20px 20px; background-color: #fff; border-radius: 8px; overflow: hidden; margin-bottom: 15px; border: 1px solid #ddd; position: relative; }
        .img-wrapper img { width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 2; }
        
        .btn { background: #4f46e5; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn:hover { background: #4338ca; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; margin-top: 10px; }

        .colors { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 1px solid #ddd; }
        
        #library-status { font-size: 11px; color: #666; margin-top: 5px; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âœ¨ AI Background Remover</h2>
        <div id="library-status">Connecting to AI Server...</div>
    </div>

    <!-- Upload -->
    <div class="upload-box" id="upload-view" onclick="triggerUpload()">
        <div style="font-size:40px;">ðŸ“·</div>
        <h3 style="margin:10px 0; color:#333;">Upload Image</h3>
        <p style="color:#666; font-size:13px;">Supports JPG, PNG, WEBP</p>
    </div>
    <input type="file" id="fileIn" accept="image/*" style="display:none">

    <!-- Loading -->
    <div class="loader" id="loader-view">
        <div class="spinner"></div>
        <strong id="status-text">Processing Image...</strong>
        <p style="font-size:12px; color:#666;">Please wait while AI works.</p>
    </div>

    <!-- Result -->
    <div class="result-box" id="result-view">
        <div class="img-wrapper">
            <img id="res-img">
        </div>
        
        <div class="colors">
            <div class="dot" style="background:linear-gradient(45deg,#ccc 25%,transparent 25%); background-size:8px 8px;" onclick="setBg(null)" title="Transparent"></div>
            <div class="dot" style="background:#fff;" onclick="setBg('#fff')"></div>
            <div class="dot" style="background:#000;" onclick="setBg('#000')"></div>
            <div class="dot" style="background:#ef4444;" onclick="setBg('#ef4444')"></div>
            <div class="dot" style="background:#3b82f6;" onclick="setBg('#3b82f6')"></div>
        </div>

        <button class="btn" onclick="dl()">â¬‡ Download HD PNG</button>
        <button class="btn btn-outline" onclick="location.reload()">ðŸ”„ New Image</button>
    </div>
</div>

<!-- LOAD SCRIPT WITH ERROR HANDLING -->
<script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.3.0/dist/imgly-background-removal.min.js" crossorigin="anonymous" onload="libLoaded()" onerror="libError()"></script>

<script>
    // --- Variables ---
    const fileIn = document.getElementById('fileIn');
    const upView = document.getElementById('upload-view');
    const loadView = document.getElementById('loader-view');
    const resView = document.getElementById('result-view');
    const resImg = document.getElementById('res-img');
    const statusTxt = document.getElementById('status-text');
    const libStatus = document.getElementById('library-status');
    
    let blobData = null;
    let bgCol = null;
    let isLibReady = false;

    // --- Library Loading Checks ---
    function libLoaded() {
        isLibReady = true;
        libStatus.innerText = "AI Ready âœ…";
        libStatus.style.color = "lightgreen";
    }

    function libError() {
        libStatus.innerText = "Error loading AI Library âŒ";
        libStatus.style.color = "#ffcccc";
        alert("Failed to load AI Library. Please refresh the page.");
    }

    function triggerUpload() {
        if(!isLibReady) {
            alert("Please wait, AI Model is still loading...");
            return;
        }
        fileIn.click();
    }

    // --- Main Logic ---
    fileIn.addEventListener('change', async (e) => {
        if(e.target.files[0]) {
            const file = e.target.files[0];
            
            // UI Update
            upView.style.display = 'none';
            loadView.style.display = 'block';
            statusTxt.innerText = "Downloading AI Model (First time takes 10s)...";

            try {
                // IMPORTANT: Point to JSDelivr for assets (WASM files)
                const config = {
                    publicPath: 'https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.3.0/dist/',
                    progress: (key, current, total) => {
                        const pct = Math.round((current/total)*100);
                        if(key === 'fetch') statusTxt.innerText = `Loading Model... ${pct}%`;
                        if(key === 'compute') statusTxt.innerText = `Removing Background... ${pct}%`;
                    }
                };

                // Check if function exists before calling
                if (typeof imglyRemoveBackground === 'undefined') {
                    throw new Error("Library function not found. Reload page.");
                }

                blobData = await imglyRemoveBackground(file, config);
                const url = URL.createObjectURL(blobData);
                
                resImg.src = url;
                
                // Show Result
                loadView.style.display = 'none';
                resView.style.display = 'block';

            } catch(err) {
                console.error(err);
                alert('Error: ' + err.message);
                location.reload();
            }
        }
    });

    // --- Helper Functions ---
    function setBg(c) {
        bgCol = c;
        resImg.style.background = c ? c : 'transparent';
    }

    function dl() {
        if(!blobData) return;
        
        const cvs = document.createElement('canvas');
        const ctx = cvs.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
            cvs.width = img.naturalWidth;
            cvs.height = img.naturalHeight;
            
            if(bgCol) { 
                ctx.fillStyle = bgCol; 
                ctx.fillRect(0,0,cvs.width,cvs.height); 
            }
            
            ctx.drawImage(img, 0, 0);
            
            const a = document.createElement('a');
            a.download = 'removed-bg.png';
            a.href = cvs.toDataURL('image/png');
            a.click();
        };
        
        img.src = URL.createObjectURL(blobData);
    }
</script>
</body>
</html>
